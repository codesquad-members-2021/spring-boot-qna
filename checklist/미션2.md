## 미션 2. 데이터베이스 활용

## 강의 듣기
- [ ] H2 DB 추가 및 설정
    - H2 데이터베이스에 대한 의존관계 설정 및 설정
    - H2 데이터베이스 관리툴 확인

- [ ] 회원가입, 목록 기능 구현
    - 데이터베이스의 테이블과 자바 객체를 매핑
    - 회원가입 기능을 DB를 사용하도록 수정
    - 회원목록 기능을 DB를 사용하도록 수정

- [ ] 개인정보 수정 기능 구현
    - 웹 애플리케이션 개발의 기본 흐름을 이해할 때 가장 복잡한 과정 중의 하나가 데이터베이스에 추가된 정보를 수정하는 것
    - 2편에 걸쳐서 강의 진행

## 사용자 데이터를 DB에 저장

### 데이터베이스 설정

- [X] 의존관계 설정
    - | build.gradle | - spring-boot-starter-data-jpa, h2 라이브러리에 대한 의존관계를 설정
       ```xml
      dependencies {
          implementation 'org.springframework.boot:spring-boot-starter-data-jpa'
          runtimeOnly 'com.h2database:h2'
      }
       ```
        - [참고](https://spring.io/guides/gs/accessing-data-jpa/)
    - | application.properties | - DB Connection 설정
      ```java
         spring.datasource.url=jdbc:h2:mem://localhost/~/java-qna;MVCC=TRUE;DB_CLOSE_ON_EXIT=FALSE
         spring.datasource.driverClassName=org.h2.Driver
         spring.datasource.username=sa
         spring.datasource.password=
         
         spring.jpa.database-platform=org.hibernate.dialect.H2Dialect
      ```
    - | application.properties | - 테이블 자동 생성 설정
        - 서버 시작 시점에 DB 테이블 drop후 다시 생성하도록 설정 → 👀 일단 처음에는 이걸로 설정해보자
            ```java
            spring.jpa.hibernate.ddl-auto=create-drop
            ```
        - 서버 시작 시점에 DB 테이블이 drop하지 않도록 설정하는 방법
            ```java
            spring.jpa.hibernate.ddl-auto=create-drop
            ```
    - | application.properties | - 실행 쿼리 보기 설정
      ```java
      spring.jpa.show-sql=true
      spring.jpa.properties.hibernate.format_sql=true
      ```
    - | application.properties | - h2 db console에 접근 설정
      ```java
      spring.h2.console.enabled=true
      spring.h2.console.path=/h2-console
      ```

- [X] User 클래스를 DB 테이블에 매핑
   ```java
   import javax.persistence.Column;
   import javax.persistence.Entity;
   import javax.persistence.GeneratedValue;
   import javax.persistence.GeneratedType;
   import javax.persistence.Id;
   
   @Entity
   public class User {
   @Id
   @GeneratedValue(strategy = GenerationType.IDENTITY)
   private Long id;
   
       @Column(nullable=false, length=20)
       private String userId;
       
       private String password;
       private String name;
       private String email;
       
       [...각 필드에 대한 setter, getter method...]
   }
   ```
    - [X] 사용자 데이터에 대한 CRUD 구현
        - CrudRepository 인터페이스를 상속 → CRUD 기본 기능 구현 가능
       ```java
       import org.springframework.data.jpa.repository.CrudRepository;
 
         public interface UserRepository extends CrudRepository<User, Long>{
            // ...
         }  
       ```

#### Controller에서 Repository 사용
- 데이터 저장을 위해 ArrayList 대신 DB 사용(Repository 클래스를 활용)
- [X] UserRepository 구현
    - @Autowired 추가

- [X] DB에 사용자 데이터 추가
- UserRepository의 save() 메소드
  ```java
  @Controller
  @RequestMapping("/users")
  public class UserController {
  
  @Autowired
  private UserRepository userRepository;
  
  @PostMapping("")
  public String create(User user) {
      System.out.println("user : " + user);
      userRepository.save(user);
      return "redirect:/users";
    }
  }

  ```

- [X] DB에서 전체 사용자 목록 조회
    - UserRepository의 findAll() 메소드
      ```java
      @Controller
      @RequestMapping("/users")
      public class UserController {
        
      @Autowired
      private UserRepository userRepository;
        
        [... 사용자 추가 코드 ...]
        
      @GetMapping("")
      public String list(Model model) {
           model.addAttribute("users", userRepository.findAll());
           return "/user/list";
        }
      }
  
      ```

- [X] DB에서 특정 사용자 조회
    - 사용자 목록을 출력하는 곳에서 {{@index}}를 사용하는 대신 {{id}}를 사용
    - UserRepository의 findOne() 메소드
      ```java
      @Controller
      @RequestMapping("/users")
      public class UserController {
      @Autowired
      private UserRepository userRepository;
        
      @GetMapping("/{id}")
      public ModelAndView show(@PathVariable long id) {
         ModelAndView mav = new ModelAndView("user/profile");
         mav.addObject("user", userRepository.findById(id).get());
         return mav;
        }
      }
  
      ```

### 실습 - 질문 데이터를 DB에 저장 및 조회
#### 질문 데이터 저장하기
- [ ] Question 클래스를 DB 테이블과 매핑
    - @Id, @GeneratedValue - key 생성
    - @Column - 필드와 테이블 칼럼 핑
- [X] QuestionRepostory 구현
   - extends CrudRepository
- [ ] QuestionController와 QuestionRepoistory 의존관계 설정
   - @Autowired 추가
- [ ] Question 데이터, DB에 저장
   - QuestionRepository의 save() 구현

#### 질문 목록 구현하기
- [ ] 전체 질문 목록 데이터 조회
   - QuestionRepository의 findAll() 구현

#### 질문 상세보기 구현하기
- [ ] 특정 질문 데이터 조회
    - QuestionRepository의 findOne() 구현

### 회원정보 수정

- [X] 개인정보 수정 화면
    - updateForm(@PathVariable String id) 메소드 시그니처 수정

- [X] 회원 정보 수정 로직 변경
    - 수정한 정보를 User 클래스에 저장
        - User 커맨드 객체로 요청 파라미터 사용
    - url로 받은 {id}를 통해 해당하는 사용자 정보를 DB에서 조회
        - UserRepository의 findOne() 사용
    - DB에서 조회한 User 데이터를 새로 입력받은 데이터로 업데이트
        - UserRepository의 save() 메소드를 사용

- [X] 수정 정보 전달 시 PUT 메소드 사용
    - 수정된 값을 전송할 때 PUT값을 `hidden`으로 전송
      ```html
      <input type="hidden" name="_method" value="PUT" />
      ```
      - html form 자체에서는 put과 post 밖에 지원하지 않는다. 
      - [Using PUT method in HTML form](https://stackoverflow.com/questions/8054165/using-put-method-in-html-form)
    - `_method`으로 PUT 전달 시 UserController의 @PutMapping으로 URL을 매핑 가능

### 리펙토링

 - [ ] @Autowired 대신 생성자로 Repository 의존성 주입
 - [ ] Entity 객체 setter 제거, 생성자 정의
 - [ ] Repository객체.findById().get() 지양
     - [Optional 제대로 활용하기](https://www.latera.kr/blog/2019-07-02-effective-optional/)

### 에러
- updateForm에서 usedrId를 못읽어오는 현상
  - `disabled` 키워드 대신 `readonly="true"` 사용
    - [참고 - How can I get the form value from a disabled input element](https://stackoverflow.com/questions/524222/how-can-i-get-the-form-value-from-a-disabled-input-element/679397)

