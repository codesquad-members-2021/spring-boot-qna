### ë¯¸ì…˜4. ê°ì²´-ê´€ê³„ ë§¤í•‘

### Userì™€ Question ì—°ê²° - ì´ë¯¸ ë¯¸ì…˜ 3ì—ì„œ êµ¬í˜„
> í˜„ì¬ Questionì˜ ê¸€ì“´ì´ëŠ” Userì˜ name ê°’ì„ ê°€ì§€ëŠ” ê²ƒìœ¼ë¡œ êµ¬í˜„í–ˆë‹¤.

> ì´ì™€ ê°™ì´ êµ¬í˜„í•˜ëŠ” ê²½ìš° Userì˜ nameì„ ìˆ˜ì •í•˜ëŠ” ê²½ìš° Questionì˜ ê¸€ì“´ì´ì™€ ë‹¤ë¥¸ ê°’ì„ ê°€ì§€ëŠ” ë¬¸ì œê°€ ë°œìƒí•œë‹¤.
> ì´ ë¬¸ì œë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´ Userì˜ nameì´ ë³€ê²½ë  ë•Œë§ˆë‹¤ Questionì˜ writer ê°’ì„ ìˆ˜ì •í•  ìˆ˜ë„ ìˆì§€ë§Œ ì´ì™€ ê°™ì´ êµ¬í˜„í•  ê²½ìš° writerê°€ ê°™ì€ ì´ë¦„ì„ ê°€ì§€ëŠ” ê²½ìš° ë¬¸ì œê°€ ë  ìˆ˜ ìˆë‹¤.

> ì´ ê°™ì€ ë¬¸ì œ ìƒí™©ì— ëŒ€í•´ ì›ë¡ ì ìœ¼ë¡œ ë¬¸ì œê°€ ë°œìƒí•˜ì§€ ì•Šë„ë¡ í•´ê²°í•œë‹¤.

- [X] @ManyToOne ë§¤í•‘
  ```java
    @Entity
 public class Question {
       @ManyToOne
  @JoinColumn(foreignKey = @ForeignKey(name = "fk_question_writer"))
       private User writer;

         [...]
      }
   ```


### ë‹µë³€ ì¶”ê°€í•˜ê¸° - ì´ë¯¸ ë¯¸ì…˜ 3ì—ì„œ êµ¬í˜„
> ì‚¬ìš©ìëŠ” ì§ˆë¬¸ ìƒì„¸ë³´ê¸° í™”ë©´ì—ì„œ ë‹µë³€ ëª©ë¡ì„ ë³¼ ìˆ˜ ìˆë‹¤.

> ë¡œê·¸ì¸í•œ ì‚¬ìš©ìëŠ” ë‹µë³€ì„ ì¶”ê°€í•  ìˆ˜ ìˆë‹¤.

> ìì‹ ì´ ì“´ ë‹µë³€ì„ ì‚­ì œí•  ìˆ˜ ìˆë‹¤.

- [X] Answerì— @ManyToOne
  ```java
   @Entity
 public class Answer {
      @ManyToOne
  @JoinColumn(foreignKey = @ForeignKey(name = "fk_answer_to_question"))
         private Question question;

          [...]
     }
  ```
- [X] AnswerRepository
  - findByQuestionId(questionId)ì™€ ê°™ì€ ë©”ì†Œë“œë¥¼ ì¶”ê°€

- [X] Answer url
  - "/questions/{questionId}/answers/{id} "


### @OneToMany ë§¤í•‘ ì „ëµ - ì´ë¯¸ ë¯¸ì…˜ 3ì—ì„œ êµ¬í˜„
- [X] Questionì´ Answerì™€ @OneToMany ê´€ê³„
  - â€œquestionâ€ì€ Answerì—ì„œ @ManyToOneìœ¼ë¡œ ë§¤í•‘í•œ í•„ë“œì˜ ì´ë¦„
  ```java
  @OneToMany(mappedBy="question")
  ```

### ë‹µë³€ ì‚­ì œí•˜ê¸° - ì´ë¯¸ ë¯¸ì…˜ 3ì—ì„œ êµ¬í˜„
- [X] ë‹µë³€ ì‚­ì œ ë©”ì†Œë“œ ì¶”ê°€
  - @DeleteMapping
  - url : "/questions/{questionId}/answers/{id}"

### ì§ˆë¬¸ ì‚­ì œí•˜ê¸° ì‹¤ìŠµ(ì„ íƒ)
- âœ” ì§ˆë¬¸ì„ ì‚­ì œí•  ë•Œ ë‹µë³€ ë˜í•œ ì‚­ì œí•´ì•¼ í•˜ë©°, ë‹µë³€ì˜ ì‚­ì œ ë˜í•œ ì‚­ì œ ìƒíƒœ(deleted)ë¥¼ ë³€ê²½

- [X] soft-deleted
  - ì§ˆë¬¸ ë°ì´í„°ë¥¼ ì™„ì „íˆ ì‚­ì œí•˜ëŠ” ê²ƒì´ ì•„ë‹ˆë¼ ë°ì´í„°ì˜ ìƒíƒœë¥¼ ì‚­ì œ ìƒíƒœ(deleted - boolean type)ë¡œ ë³€ê²½í•œë‹¤.

- [X] ì‚­ì œ ê°€ëŠ¥í•œ ê²½ìš°
  - ë¡œê·¸ì¸ ì‚¬ìš©ìì™€ ì§ˆë¬¸í•œ ì‚¬ëŒì´ ê°™ì€ ê²½ìš°
  - ë‹µë³€ì´ ì—†ëŠ” ê²½ìš°
  - ì§ˆë¬¸ìì™€ ë‹µë³€ ê¸€ì˜ ëª¨ë“  ë‹µë³€ì ê°™ì€ ê²½ìš°

- [X] ì‚­ì œ ë¶ˆê°€ëŠ¥í•œ ê²½ìš°
  - ì§ˆë¬¸ìì™€ ë‹µë³€ìê°€ ë‹¤ë¥¸ ê²½ìš° ë‹µë³€ì„ ì‚­ì œí•  ìˆ˜ ì—†ë‹¤.


### soft-deleted
#### ê·¸ëƒ¥ deleteê³¼ ë¬´ì—‡ì´ ë‹¤ë¥¸ê°€?
  - [ì°¸ê³ ](https://github.com/spring-projects/spring-data-jpa/issues/676#issuecomment-752422516)
   ```text
    Generally a delete has the following impacts:

    - Delete the entity (DELETE op)
    - Cascade the DELETE op

    And soft delete changes the delete action in the following ways:

    - Mark entity as deleted/inactive (UPDATE op)
    - Filter all fetch queries to find active records only
    - Cascade the inactive marking (or soft delete) to other elements
   ```
  - deleteì€ ë§ ê·¸ëŒ€ë¡œ dbì—ì„œ **ì‚­ì œ**
  - soft-deleteì€ í•´ë‹¹ ë°ì´í„°ì˜ ìƒíƒœë¥¼ inactiveë¡œ **ì—…ë°ì´íŠ¸** í•´ì¤€ë‹¤. delete ìƒíƒœë¥¼ activeë¥¼ í†µí•´ ê´€ë¦¬í•˜ëŠ” ê²ƒì´ soft-delete
#### ì™œ í•„ìš”í•œê°€?
  - [ì°¸ê³ ](https://dzone.com/articles/to-delete-or-to-soft-delete-that-is-the-question)
  - ì£¼ëœ ì´ìœ ëŠ” ê¸°ìˆ ì ì¸ ì´ìœ ë³´ë‹¤ëŠ” ì‚¬ìš©ì„± ë•Œë¬¸..?
    1. History tracking and audit (e.g. for legal reasons)
    2. Keeping reference integrity and avoid cascade delete
    3. You need â€œGracefulâ€ delete. E.g. a long-running business process may need data that might be â€œdeletedâ€, but still required for this particular process to finish

#### ì–´ë–»ê²Œ ì‚¬ìš©í•˜ëŠ”ê°€?
  - [ì°¸ê³ ](https://stackoverflow.com/a/33168644)
  - `#{#entityName}` ì‚¬ìš©
  - ```java
	  //Override CrudRepository or PagingAndSortingRepository's query method:
	  @Override
	  @Query("select e from #{#entityName} e where e.deleteFlag=false")
	   public List<T> findAll();
    ```

#### isActive ì—…ë°ì´íŠ¸ ë°©ì‹ ê³ ë¯¼
- ì¿¼ë¦¬ë¬¸ì„ í†µí•´ ì§ì ‘ update
	 ```java
	  @Query("UPDATE #{#entityName} q SET q.isActive=false WHERE q.id=?1")
	  @Modifying
	  void softDelete(long id);
    ```

 - @DeleteMappingì„ ì‚¬ìš©í•˜ëŠ”ë° delete() ë©”ì†Œë“œë¥¼ ì‚¬ìš©í•˜ì§€ ì•Šì•„ì„œ ì—ëŸ¬ ë°œìƒ
    - ë””í´íŠ¸ ë©”ì†Œë“œë¡œ delete() ë©”ì†Œë“œ ì¬ì •ì˜
    ```java
     @Query("UPDATE #{#entityName} q SET q.isActive=false WHERE q.id=?1")
     @Modifying
     void softDelete(Long id);

     @Override
     default void delete(Question question) {
         softDelete(question.getId());
     }
    ```

- ë”í‹°ì²´í‚¹ ë°©ì‹ ì‚¬ìš©
  ```java
  public void delete(long id, HttpSession session){
     Question question = authenticate(id, session);
     question.setDelete(); // ë‚´ë¶€ì ìœ¼ë¡œ question.isActive = false;  questionRepository.save(question);
  }
  ```


### ğŸš¨ ìì§ˆêµ¬ë ˆ ì—ëŸ¬

- `@Column(name="is_active")` ì¶”ê°€ ì‹œ 'Cannot resolve column' ì—ëŸ¬ ë°œìƒ
  - Unresolved database references in annotations ì˜µì…˜ì„ off - [ì°¸ì¡°](https://stackoverflow.com/questions/29155350/jpa-cannot-resolve-column-intellij)
- update'@Modifying'
  - @Modifying ë°˜ë“œì‹œ ì¶”ê°€í•´ ì£¼ì–´ì•¼ í•¨
  - @Modifying annotation include INSERT, UPDATE, DELETE, and DDL statements. - [ì°¸ì¡°](https://stackoverflow.com/questions/19323557/handling-soft-deletes-with-spring-jpa)
  - clearAutomaticallyì™€ flushAutomatically ì˜µì…˜ ì¡´ì¬ - [ì°¸ì¡°](https://www.baeldung.com/spring-data-jpa-modifying-annotation#clear)
    - ì•„ì§ ì •í™•í•˜ê²Œ ì™œ ì¨ì•¼í•˜ëŠ”ì§€ëŠ” ì˜ ëª¨ë¥´ê² ìŒ, ì•Œì•„ë§Œë‘ì

### ìˆ˜ì • ë° ë¦¬í™í† ë§
 - [X] @~Mapping() â†’ @~Mapping
 - [ ] ë‹¨ë°©í–¥ ë§¤í•‘ìœ¼ë¡œ ìˆ˜ì •
 - [X] DateTimeUtils í´ë˜ìŠ¤ êµ¬í˜„
   - ëŒ€ì‹  
       ```java
        private static final DateTimeFormatter DATE_TIME_FORMATTER = DateTimeFormatter.ofPattern("yyyy-MM-dd HH:mm:ss");
       ```
   
 - [X] `@Column(name="is_active")`
    - êµ³ì´ is_activeë¼ê³  ì„¤ì •í•´ì£¼ì§€ ì•Šì•„ë„ ë¨.
    - (+) @Column ë””í´íŠ¸ ì†ì„± ê°’ ì„¤ì •
      - `true` ê°’ì„ manually assign í•´ì£¼ëŠ” ëŒ€ì‹ , `columnDefinition = "boolean default true"` ì‚¬ìš©
      - [ì°¸ì¡°](https://stackoverflow.com/questions/28207359/how-to-set-default-boolean-value-in-jpa)
    
 - [X] Builder ê¸°ë³¸ìƒì„±ìë¥¼ private
    - í•„ìˆ˜ í•„ë“œë³€ìˆ˜ë¥¼ ë°›ëŠ” ìƒì„±ìë§Œ publicìœ¼ë¡œ 
       - (ì´ë ‡ê²Œ ë˜ë©´ privateì¸ ê¸°ë³¸ ìƒì„±ìê°€ ì• ì´ˆì— í•„ìš”í•œê°€..?)
        - ê·¸ë˜ì„œ ê¸°ë³¸ ìƒì„±ìëŠ” ì•„ì˜ˆ ì‚­ì œ
    - 

 - [X] CRUDAuthenticationException ë„¤ì´ë° ìˆ˜ì •
    - CrudNotAllowedException
    - 'ì¸ì¦'ì´ë¼ëŠ” ë‹¨ì–´ê°€ DBì—ì„œëŠ” ì˜ ì“°ì´ì§€ ì•ŠëŠ”ë‹¤.
    - CRUD ëª¨ë‘ ëŒ€ë¬¸ì ë³´ë‹¤ëŠ” Crudê°€ ë” ì ì ˆí•´ë³´ì¸ë‹¤.
    
 - [X] id ë„¤ì´ë°
    - ì–´ë–¤ entityì˜ idì¸ì§€ ëª…í™•í•˜ê²Œ ë°íˆëŠ” ê²ƒì´ ì¢‹ìŒ (questionId, answerId .. etc)

 - [X] AnswerService create() ë©”ì†Œë“œ íŒŒë¼ë¯¸í„° ìˆ˜ì •
   - í˜„ì¬ ë©”ì†Œë“œ 
     ```java
        public void create(long questionId, String contents, HttpSession session) { //...};
     ```
     
   - HttpSession ëŒ€ì‹  Userë¥¼ ë°›ì•„ì˜¤ëŠ” ê²ƒì´ ë” ì ì ˆ
    
- [X] `@Transactional`
   - ì„œë¹„ìŠ¤ ê³„ì¸µì— Transational ì¶”ê°€
    - ì›ìì„±ì„ ìœ ì§€í•´ì•¼í•˜ëŠ” ë¸”ë¡ ë‹¨ìœ„ë¡œ ì„¤ì •í•´ì•¼ í•¨.
    - ë‹¨ìˆœí•œ ì¡°íšŒë¬¸ì€ readonly ì„¤ì •

- [X] ë©”ì„œë“œ ì´ë¦„ì€ ë™ì‚¬
   - ex) QuestionService í˜¹ì€ UserServiceì˜ list() ë©”ì†Œë“œ ì´ë¦„ â†’ getAnswersByQuestionId()ì™€ ê°™ì´ ë™ì‚¬ë¡œ ë³€ê²½
    
- [ ] Dto ìƒì„±
   - Entityì™€ ì§ì ‘ì ì¸ ê´€ë ¨ì´ ì—†ëŠ” ë¶€ë¶„ì€ Entity ëŒ€ì‹  dto ì‚¬ìš©
   - ex) UserServiceì—ì„œ loginUser
      -  `User loginUser = SessionUtils.getLoginUser(session);`ì—ì„œ User ì—”í‹°í‹° ëŒ€ì‹  UserSessionDtoì™€ ê°™ì€ dto íƒ€ì…ìœ¼ë¡œ ë‹´ì•„ë‚´ëŠ” ê²ƒì´ ì¢‹ì•„ë³´ì¸ë‹¤.
