### ë¯¸ì…˜ 5

 
### AJAXë¡œ ë‹µë³€ ì¶”ê°€ ê¸°ëŠ¥ êµ¬í˜„
ì§ˆë¬¸ì— ë‹µë³€ì„ ì¶”ê°€í•˜ëŠ” í™”ë©´ì´ ê¹œë¹¡ì´ì§€ ì•Šìœ¼ë©´ì„œ(AJAX í™œìš©) ë‹µë³€ì„ ì¶”ê°€í•œë‹¤. ì¦‰, í™”ë©´ì„ ìƒˆë¡œê³ ì¹¨í•˜ì§€ ì•Šê³  ë³€ê²½ëœ ì‚¬í•­ë§Œ ajaxì„ í†µí•´ ë°˜ì˜ë˜ë„ë¡ ìˆ˜ì •.

- [X] ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ë“±ë¡ 
  - scripts.jsì— êµ¬í˜„
   ```javascript
   $(".submit-write button[type=submit]").click(addAnswer);
   ```
- [X] ì„œë²„ë¡œ ë³´ë‚¼ form ë°ì´í„° ë¬¶ê¸°
   ```javascript
    function addAnswer(e) {
        e.preventDefault(); //submit ì´ ìë™ìœ¼ë¡œ ë™ì‘í•˜ëŠ” ê²ƒì„ ë§‰ëŠ”ë‹¤.
    
  //form dataë“¤ì„ ìë™ìœ¼ë¡œ ë¬¶ì–´ì¤€ë‹¤.
  // key-value í˜•íƒœë¡œ ë°˜í™˜-> contents = "ì…ë ¥í•œ ë‹µë³€"
        var queryString = $(".submit-write").serialize(); 
        console.log("query : "+ queryString);
    }
   ```
- [X] ì„œë²„ë¡œ ë°ì´í„°ë¥¼ ì „ì†¡
   ```javascript
   function addAnswer(e) {
        e.preventDefault();
        
        var queryString = $("form[name=answer]").serialize();
    
        var url = $(".answer-write").attr("action");
        console.log("url : " + url);
        
        $.ajax({
            type : 'post',
            url : url,
            data : queryString,
            dataType : ' json',
            error: onError,
            success : onSuccess,
        });
    }
   ```
- [X] ì„œë²„ì—ì„œ ë°ì´í„° ì²˜ë¦¬ ë° JSON ì‘ë‹µ
   - í´ë˜ìŠ¤ ëª… ìˆ˜ì • 
      - AnswerController â†’ ApiAnswerController
    - `@Controller`ëŒ€ì‹  `@RestController` ì–´ë…¸í…Œì´ì…˜ ì¶”ê°€
    - create() ë©”ì†Œë“œ ìˆ˜ì • 
      - ê¸°ì¡´ ì½”ë“œ
      ```java
        @PostMapping
        public String create(@PathVariable long questionId, String contents, HttpSession session) {
            //.. 
            return "redirect:/questions/" + questionId;       
        }
      ```
      - ìˆ˜ì • ë’¤
      ```java
        @PostMapping
        public Answer create(@PathVariable long questionId, String contents, HttpSession session) {
            //.. 
            Answer answer = new Answer(loginUser, question, contents);
            return answerRepository.save(answer);   // ğŸ‘ˆğŸ‘ˆ Answer ê°ì²´ë¥¼ ê·¸ëŒ€ë¡œ ë¦¬í„´
        }
      ```
      - getter ëŒ€ì‹  ì—”í‹°í‹° í•„ë“œ ë³€ìˆ˜ì—`@JsonProperty` ì¶”ê°€
      - ë³´ì—¬ì£¼ê³ ì‹¶ì§€ ì•Šì€ ë°ì´í„°, í•„ë“œ ë³€ìˆ˜ì—  `@JsonIgnore` ì¶”ê°€
- [X] í´ë¼ì´ì–¸íŠ¸(í¬ë¡¬)ì—ì„œ JSON ì‘ë‹µ í™•ì¸
   - addAnswer(e) í•¨ìˆ˜ ìˆ˜ì •
     - ê°’ì„ ì •ìƒì ìœ¼ë¡œ ë°›ì•„ì˜¤ì§€ ëª»í–ˆì„ ê²½ìš°(error), failure ì¶œë ¥
     - ê°’ì„ ì •ìƒì ìœ¼ë¡œ ë°›ì•„ì™”ì„ ê²½ìš°(success), ì„œë²„ì—ì„œ ë°›ì•„ì˜¨ data ì¶œë ¥
    
     ```javascript
     function addAnswer(e) {
      e.preventDefault();
    
      var queryString = $("form[name=answer]").serialize();
    
      var url = $(".answer-write").attr("action");
      console.log("url : " + url);
    
      $.ajax({
          type : 'post',
          url : url,
          data : queryString,
          dataType : 'json',
          error: function () {
            console.log('failure');
            },
          success : function (data, status) {
            console.log(data);
            }
        });
      }
     ```
     
- [X] í´ë¼ì´ì–¸íŠ¸ì—ì„œ JSON ë°ì´í„° ì²˜ë¦¬
    - ajaxì—ì„œ successì¼ ê²½ìš° í˜¸ì¶œí•˜ëŠ” í•¨ìˆ˜ ë³€ê²½
    ```javascript
       success : function (data, status) {
            console.log(data);
  // ë‹µë³€ í…œí”Œë¦¿ ê°€ì ¸ì˜´
            var answerTemplate = $("#answerTemplate").html();
  // ë³€ê²½ëœ ì •ë³´ í…œí”Œë¦¿ì— ë¶™ì´ê¸°
            var template = answerTemplate.format(data.writer.userId, data.formattedCreateDate, data.contents, data.question.id, data.id);
  // ëŒ“ê¸€ë“¤ ê°€ì¥ ë§ˆì§€ë§‰ì— ë³€ê²½ëœ ë‹µë³€ ë¶™ì´ê¸°
            $(".qna-comment-slipp-articles").prepend(template);            
            $("textarea[name=contents]").val("");
        }
    ```

### AJAXë¡œ ë‹µë³€ ì‚­ì œ ê¸°ëŠ¥ êµ¬í˜„
- [X] ëª¨ë“  ì‚­ì œ ë§í¬ ì„ íƒ
   ```javascript
    $(".delete-answer-form button[type='submit']").click(deleteAnswer);
   ```

- [X] ìƒìœ„ form íƒœê·¸ì˜ url(action ì†ì„±) êµ¬í•˜ê¸°
   - í´ë¦­í•œ ì‚­ì œ ë²„ì „ ì—˜ë¦¬ë¨¼íŠ¸ëŠ” thisë¡œ ê°€ëŠ¥í•¨(`$(this)`)
     - ì¼ë‹¨ console.log()ë¡œ í™•ì¸í•´ë³´ì
       ```javascript
        function deleteAnswer(e) {
            console.log(this);
        }
       ```
     - ì´í›„ this ê°’ì„ local ë³€ìˆ˜ì— ì €ì¥í•´ì„œ ì‚¬ìš©
       ```javascript
        var deleteBtn = $(this);
       ```
   - ë¶€ëª¨ íƒœê·¸ ì ‘ê·¼
     - parent() function ì‚¬ìš©
    
- [X] ajax í˜¸ì¶œ êµ¬í˜„
     ```javascript
     function deleteAnswer(e) {
     // ...
    
      $.ajax({
          type : 'delete',
          url : url,
          data : queryString,
          dataType : 'json',
          error: function () {
            console.log('failure');
            },
          success : function (data, status) {
            console.log(data);
            }
        });
      }
     ```
- [X] Result í´ë˜ìŠ¤ í™œìš©
  - Result ëŒ€ì‹  ResponseResultê°€ ì¡°ê¸ˆ ë” ëª…í™•í•œ ë„¤ì´ë°ì¼ ë“¯
  - domain íŒ¨í‚¤ì§€ ì•„ë˜ ìœ„ì¹˜
  - ë‹µë³€ ì‚­ì œ ì„±ê³µ â†’ Result.ok()
  - ì‹¤íŒ¨ â†’ Result.fail(â€œerror messageâ€)
  - [ì°¸ê³ ](https://www.youtube.com/watch?v=g-nsT3NRK2o)
    
- [X] htmlì—ì„œ ë‹µë³€ ì‚­ì œ
  - ì„œë²„ ì‘ë‹µ status ê°’ == true â†’ ë‹µë³€ ì‚­ì œ
    ```javascript
    function deleteAnswer(e) {
        var deleteBtn = $(this);
        
        $.ajax({
            [...],
            success : function (data, status) {            
                deleteBtn.closest("article").remove();
            }
        });
    }
    ```
   - í´ë¦­í•œ element($(this))ì—ì„œ ê°€ì¥ ê°€ê¹Œìš´ article elementë¥¼ ì°¾ì•„ ì‚­ì œ(remove function)
    
### Swagger ë¬¸ì„œí™”
 - gradle ì˜ì¡´ì„± - [ì°¸ê³ ](http://springfox.github.io/springfox/docs/current/#gradle)
 - MvcConfig ë¹ˆ ì„¤ì • - [ì°¸ê³ ](https://springboot.tistory.com/23)
 - "http://localhost:8080/swagger-ui/"ë¡œ ì ‘ì†í•´ì•¼ í•¨

### ğŸš¨ ì—ëŸ¬ ë°œìƒ

#### HttpMessageNotWritableException ì˜ˆì™¸ ë°œìƒ
  - * ë‹¨ë°©í–¥ì¼ ë•Œ
  - ì˜ˆì™¸ ë©”ì‹œì§€ : Could not write JSON: failed to lazily initialize a collection of role
  - ì›ì¸ : User í´ë˜ìŠ¤ì— ë§Œë“¤ì–´ì¤€ Answer ë¦¬ìŠ¤íŠ¸ì— ì„¤ì •ëœ ì§€ì—°ë¡œë”© ì„¤ì •(fetch = FetchType.LAZY) 
      â†’ ì‹¤ì œ ê°ì²´ê°€ ì•„ë‹Œ í”„ë¡ì‹œ ê°ì²´ë¥¼ ì°¸ì¡°í•˜ê²Œ ë˜ì–´ë²„ë¦¼
  - í•´ê²° : fetch = FetchType.EAGER ë¡œ ìˆ˜ì •
  - ê¶ê¸ˆí•œ ì  : User ë‚´ë¶€ì— ìˆëŠ” Answer ë¦¬ìŠ¤íŠ¸ëŠ” eager ì˜µì…˜ì„ ê¼­ ë‹¬ì•„ì£¼ì–´ì•¼í•˜ëŠ” ë°˜ë©´, Questionì— ìˆëŠ” Answer ë¦¬ìŠ¤íŠ¸ëŠ” eager ì˜µì…˜ ì—†ì´ë„ ë™ì‘
  - [ì°¸ê³ ](https://stackoverflow.com/questions/42089966/could-not-write-content-failed-to-lazily-initialize-a-collection-of-role)

#### Question ì‚­ì œ ì‹œ, Answer ì‚­ì œë˜ì§€ ì•ŠëŠ” ë¬¸ì œ ë°œìƒ
  - * ì–‘ë°©í–¥ìœ¼ë¡œ ìˆ˜ì • í›„
  - í•´ê²° : User í´ë˜ìŠ¤ì˜ fetch ì˜µì…˜ ì‚­ì œí•´ì£¼ë‹ˆ ì •ìƒ ì‘ë™
  - ```java
     // User í´ë˜ìŠ¤
    @OneToMany(mappedBy = "writer", cascade = CascadeType.ALL, fetch = FetchType.EAGER) // ğŸ‘ˆ ì´ë²ˆì—ëŠ” ì´ fetch ì˜µì…˜ì´ ë¬¸ì œì˜€ìŒ
    private List<Answer> answers = new ArrayList<>();
    ```
  - JPA ë„ˆë¬´ ì–´ë µë“œì•™ ì™œ ì´ëŸ°ì§€ëŠ” ëª¨ë¥´ê² ì§€ë§Œ ì–´ì¨Œë“  ì´ì œ ë‘˜ ë‹¤ delete ì˜ì†ì„± ì „ì´

#### ìˆœí™˜ì°¸ì¡° ì—ëŸ¬ ë°œìƒ
  - ì–‘ë°©í–¥ìœ¼ë¡œ ë°”ê¿”ì¤€ ë’¤ ì•„ë˜ì™€ ê°™ì€ ì—ëŸ¬ ë°œìƒ
  - ```java
    domain.question.Question["answers"]->org.hibernate.collection.internal.PersistentBag[0]->com.codessquad.qna.web.domain.answer.Answer["question"]->com.codessquad.qna.web.domain.question.Question["answers"]->org.hibernate.collection.internal.PersistentBag[0]->
    ```
  - setter ë©”ì†Œë“œë„ ìˆœí™˜ì°¸ì¡°ë¥¼ ê³ ë ¤í•´ ì‘ì„±í•´ì£¼ì—ˆì§€ë§Œ ì—¬ì „íˆ ì—ëŸ¬ ë°œìƒ  
  - í•´ê²° : `@OneToMany`ì¸ ë¦¬ìŠ¤íŠ¸ì— `@JsonIgnore` ì¶”ê°€ ì‹œ ì •ìƒ ì‘ë™
  - [ì°¸ì¡°](https://stackoverflow.com/questions/35346794/infinite-recursion-with-jackson-json-and-hibernate-jpa-issue-yet-another)

#### ajaxì„ í†µí•´ responseë¡œ Object ë°ì´í„° ì „ì†¡ ì‹¤íŒ¨ (406 ì—ëŸ¬)
 - ApiAnswerControllerì—ì„œ ResponseResult ê°ì²´ë¥¼ ë¦¬í„´í•˜ëŠ”ë° ê³„ì† 406 ì—ëŸ¬ê°€ ë–´ë‹¤.
 - í•´ê²° : ResponseResultì— getterë¥¼ ì¶”ê°€
 - í•´ë‹¹ objectëŠ” ë°˜ë“œì‹œ getterë¥¼ ê°€ì§€ê³  ìˆì–´ì•¼ í•œë‹¤..

### ì¶”ê°€ êµ¬í˜„í•´ì•¼í•  ê²ƒë“¤
- [ ] show.html, index.html ì—ì„œ ëŒ“ê¸€ ê°œìˆ˜ ì¹´ìš´íŠ¸í•˜ëŠ” ë°©ì‹ ìˆ˜ì •
    - script.js íŒŒì¼ì— function ì¶”ê°€í•´ì•¼í•  ë“¯

